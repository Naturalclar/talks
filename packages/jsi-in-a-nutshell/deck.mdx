import Code from "mdx-code";
import { Notes, Head, Appear } from "mdx-deck";
import {
  Avatar,
  Logo,
  Meta,
  Profile,
  Title,
  AlignLeft,
  Header,
} from "@naturalclar/slides-components";
import { CodeSurferLayout, CodeSurferColumnLayout } from "code-surfer";
import "prismjs/components/prism-tsx";

<Head>
  <Meta
    title="jsi-in-a-nutshell"
    description="Enter description here"
    publishedAt={"2021-07-27T13:13:07.542Z"}
    host="https://jsi-in-a-nutshell.vercel.app"
  />
</Head>

## JSI in a nutshell

<img
  src={require("file-loader!./react-native-rearchitecture.png")}
  style={{ position: "absolute", top: 20, left: 20, opacity: 0.2 }}
  width="900"
/>

<footer style={{position:'absolute', bottom: 20, right: 20}}>

[TECH STAND #5](https://standfm.connpass.com/event/218812/)
@naturalclar

</footer>

<Notes>
  JSI in a Nutshell ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã§ç™»å£‡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚Naturalclarã§ã™ã€‚
</Notes>

---

<AlignLeft>

<Header>About Me</Header>

<Profile />

<img src={require("file-loader!./contribute.png")} width="900" />

<Notes>Introduction</Notes>

</AlignLeft>

---

<AlignLeft>

<Header>æ¦‚è¦</Header>

- JSI ã¨ã¯
- JSI ã®åˆ©ç‚¹
- JSI ã®ä½¿ã„æ–¹
- JSI ã‚’ä½¿ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªç´¹ä»‹

</AlignLeft>

---

## JSI ã¨ã¯? ğŸ¤”

---

<AlignLeft>

<Header>JSI</Header>

- **hermes**, **jsc** ãªã©ã® **JavaScript Engine** ã®ãƒ©ãƒƒãƒ‘ãƒ¼
- **React Native New Architecture** ã®ä¸€ç’°
- **C++** ã¸ã®å‚ç…§ã‚’æŒã¡ã€**JS** ã‹ã‚‰**åŒæœŸçš„**ã«å‘¼ã³å‡ºã›ã‚‹

</AlignLeft>

<Notes>
  JSI ã¨ã¯ JavaScript Interface Facebook ãŒé–‹ç™ºã—ã¦ã„ã‚‹ JavaScript Engine
  ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã™ã€‚
</Notes>

---

## React Native New Architecture

---

<Header>Old Architecture</Header>

<img
  src={require("file-loader!./react-native-architecture-yoga.png")}
  width="900"
/>

<Notes>
ç¾çŠ¶ã® Native Module ã¨ UI Rendererã€ãã—ã¦ New Architecture å¾Œã®çŠ¶æ…‹ã«ã¤ã„ã¦è©±ã™

New Architecture ã®ä¸­æ ¸ã¨ãªã‚‹ã®ãŒã“ã® JSI

</Notes>

---

<Header>Old Architecture - Bridge</Header>

- JS ã¨ Native ã®é€šä¿¡ã¯ **JSON** ã‚’é€šã—ã¦**éåŒæœŸ**ã§è¡Œã‚ã‚Œã‚‹
- UI ã®æç”»ã«ã¯ **JS** â†’ **Native** â†’ **Yoga** â†’ **Native UI** ã¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¸ã‚€å¿…è¦ãŒã‚ã‚‹
- Android ã®å ´åˆã€Bridge ã®å‡¦ç†ã¯ã™ã¹ã¦ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«äºˆã‚èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ã®ã§**èµ·å‹•é€Ÿåº¦ãŒé…ã„**
- JavaScript ã¨ Native ã¯ç–çµåˆã§ã‚ã‚Šã€äº’ã„ã«ç„¡é–¢å¿ƒ(æ‚ªã„ã“ã¨ã§ã¯ãªã„)

---

<Header>New Architecture</Header>

<img
  src={require("file-loader!./react-native-rearchitecture.png")}
  width="900"
/>

---

<Header>New Architecture - JSI ã§å¤‰ã‚ã‚‹ä¸–ç•Œ </Header>

- **TurboModules** - **JSI** ã‚’é€šã—ã¦ Native Module ã®**åŒæœŸçš„**å‘¼ã³å‡ºã—ãŒå¯èƒ½ã«
- **Fabric** - **JSI** ã‚’é€šã—ã¦ **Yoga** ã‚’ç›´æ¥å‘¼ã¹ã‚‹ãŸã‚ã€**UI ã®æç”»**ãŒã‚ˆã‚ŠåŠ¹ç‡çš„ã«
- **CodeGen** ã‚’ä½¿ã£ã¦ **Flow/TypeScript** ã¨ C++ ã‚’ç¹‹ãå‹æƒ…å ±ã‚’è‡ªå‹•ç”Ÿæˆ
- JavaScript ã¨ Native éƒ¨åˆ†ãŒ **JSI** ã‚’é€šã—ã¦äº’ã„ã‚’æ„ŸçŸ¥ã§ãã‚‹
- JavaScript ã§è¡Œã†ã«ã¯é‡ã„**æš—å·åŒ–**ç­‰ã®å‡¦ç†ã‚’ **C++** å´ã§å®Ÿè¡Œã—ã¦çµæœã‚’è¿”ã›ã‚‹

---

<Header>New Architecture - Turbo Modules</Header>

- **JSI** ã‚’é€šã—ã¦ OS å›ºæœ‰ã®æ©Ÿèƒ½ (Camera, Bluetooth ç­‰) ã‚’å‘¼ã³å‡ºã™ä»•çµ„ã¿
- **C++** ã¨ **Objective-C (iOS)**ã€åŠã³ **Java (Android)** ã®æŠ½è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼
- Objective-C ã¯ **Objective-C++** ã‚’é€šã—ã¦ C++ ã®å®Ÿè¡ŒãŒå¯èƒ½
- Java ã¯ **JNI** ã‚’é€šã—ã¦ C++ ã®å®Ÿè¡ŒãŒå¯èƒ½
- **Swift** , **Kotlin** ã§ã‚‚ JSI ã®å‘¼ã³å‡ºã—ã¯å¯èƒ½ (ä½¿ç”¨ä¾‹:[react-native-vision-camera](https://github.com/mrousavy/react-native-vision-camera))

<Notes>åŸºæœ¬èª­ã¿é£›ã°ã™</Notes>

---

<Header>New Architecture - Fabric</Header>

- **JSI** ã‚’ç”¨ã„ãŸã‚ˆã‚ŠåŠ¹ç‡çš„ãª**UI æç”»**ã®æ‰‹æ³•
- React Native ã§ Flexbox ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ **Yoga** ãŒ c++ è£½ã®ãŸã‚ã€**JSI** ã‹ã‚‰ç›´æ¥å‘¼ã¹ã‚‹
- **FlatList**ç­‰ã® Virtualized List ã®æç”»ãŒé€”åˆ‡ã‚Œãªããªã‚‹
- Facebook å†…éƒ¨ã§ã¯ **1000 ç”»é¢ä»¥ä¸Š**ã® React Native è£½ã®ç”»é¢ãŒ Fabric ã«ç§»è¡Œæ¸ˆã¿

<img src={require("file-loader!./fabric-in-facebook.png")} width="700" />

<p style={{ fontSize: 18 }}>
  <a href="https://twitter.com/joshuaisgross/status/1415099495285608453">
    https://twitter.com/joshuaisgross/status/1415099495285608453
  </a>
</p>

<Notes>åŸºæœ¬èª­ã¿é£›ã°ã™</Notes>

---

<Header>JSI å˜ä½“ã§ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹</Header>

- UI ã‚„ OS å›ºæœ‰ã®å‡¦ç†ã‚’æŒŸã¾ãªã„ C++ ã§å®Œçµã™ã‚‹å‡¦ç†
- æš—å·åŒ–ã€å¾©å·åŒ–ç­‰ã€**JS å˜ä½“ã§ã¯é‡ã„å‡¦ç†**
  - (NodeJS ã§ã‚ã‚Œã°æ—©ã„ã€ãŒ **React Native ã¯ NodeJS ã§ã¯ãªã„**)
- **ç”»åƒ**ã€**éŸ³å£°**ã€**å‹•ç”»**ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€åŠ å·¥å‡¦ç†
- ãã®ä»–ã€UI ã‚„ JS ã‚’å¦¨å®³ã›ãšã«è¡Œãˆã‚‹ã™ã¹ã¦ã®å‡¦ç†

<Notes>
  ä»Šå›ã¯JSIã‚’ä½¿ã£ã¦ã€JavaScriptã‹ã‚‰C++ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚’è¡Œã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œã‚Šæ–¹ã‚’è§£èª¬ã—ã¾ã™
</Notes>

---

## å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«

---

## C++ å´

---

<CodeSurferLayout>

```c subtitle="ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ"
// MyAwesomeModule.h
#include <jsi/jsilib.h>
#include <jsi/jsi.h>

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime);
    void cleanup();
  }
}
```

```c 2:3 subtitle="jsié–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’include"
// MyAwesomeModule.h
#include <jsi/jsilib.h>
#include <jsi/jsi.h>

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime);
    void cleanup();
  }
}
```

```c 5 subtitle="facebook::jsiã‚’jsiã¨ã—ã¦å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹"
// MyAwesomeModule.h
#include <jsi/jsilib.h>
#include <jsi/jsi.h>

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime);
    void cleanup();
  }
}
```

```c 7:8 subtitle="module ã‚’å‘¼ã³å‡ºã™ namespace ã‚’ã¤ã‘ã‚‹ï¼ˆå¿…é ˆã§ã¯ãªã„)"
// MyAwesomeModule.h
#include <jsi/jsilib.h>
#include <jsi/jsi.h>

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime);
    void cleanup();
  }
}
```

```c 9:10 subtitle="install ã¨ cleanup ã‚’å®šç¾©ã™ã‚‹"
// MyAwesomeModule.h
#include <jsi/jsilib.h>
#include <jsi/jsi.h>

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime);
    void cleanup();
  }
}
```

```cpp 8:24 subtitle="install: JavaScript ã® global ã§å‘¼ã³å‡ºã›ã‚‹é–¢æ•°ã‚’ä½œæˆã™ã‚‹"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 8:24 subtitle="(.cpp) install: JavaScript ã® global ã§å‘¼ã³å‡ºã›ã‚‹é–¢æ•°ã‚’ä½œæˆã™ã‚‹"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 8 subtitle="jsi::Runtime ã¯ JS ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’æ¨¡ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 9 subtitle="jsãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã€HostFunctionã‚’ä½œæˆ"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 10:12 subtitle="å¿…è¦ãªå¼•æ•°ã‚’æ¸¡ã™"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 13:20 subtitle="c++å´ã§å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã‚’å®šç¾©"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 22:23 subtitle="JavaScript ã® global ã« HostFunction ã‚’è¨­å®šã™ã‚‹"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

```cpp 26:28 subtitle="cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æ›¸ã"
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {
    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹
          double a = args[0].getNumber();
          double b = args[1].getNumber();
          return jsi::Value(a * b);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

    void cleanup() {
      // ä½•ã‹ã—ã‚‰ã®cleanupå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯æã
    }

  }
}
```

</CodeSurferLayout>

---

## iOS å´

---

<CodeSurferLayout>

```objectivec subtitle="iOSã¯ .mm ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãã®ã¾ã¾ c++ ãŒå‘¼ã¹ã‚‹"
// RNMyModule.mm
#import "MyAwesomeModule.h"

@implementation RNAwesomeModule
@synthesize bridge = _bridge;
@synthesize methodQueue = _methodQueue;

RCT_EXPORT_MODULE()

// Main Queue ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰èµ·å‹•ã™ã‚‹
+ (BOOL)requiresMainQueueSetup {
  return YES;
}

- (void)setBridge:(RCTBridge *)bridge
{
  _bridge = bridge;

  // JS ã¨ c++ ã®ç¹‹ãç›®ã‚’ä½œæˆã™ã‚‹ã€‚
  RCTCxxBridge *cxxBridge = (RCTCxxBridge *)self.bridge;
  if (!cxxBridge.runtime) {
    return;
  }

  naturalclar::awesomeModule::install(*(jsi::Runtime *)cxxBridge.runtime);
}

- (void)invalidate {
  naturalclar::awesomeModule::cleanup();
}


@end

```

```objectivec 10:13 subtitle="MainQueueãŒç«‹ã¡ä¸ŠãŒã‚‹ã¾ã§å¾…ã¤"
// RNMyModule.mm
#import "MyAwesomeModule.h"

@implementation RNAwesomeModule
@synthesize bridge = _bridge;
@synthesize methodQueue = _methodQueue;

RCT_EXPORT_MODULE()

// Main Queue ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰èµ·å‹•ã™ã‚‹
+ (BOOL)requiresMainQueueSetup {
  return YES;
}

- (void)setBridge:(RCTBridge *)bridge
{
  _bridge = bridge;

  // JS ã¨ c++ ã®ç¹‹ãç›®ã‚’ä½œæˆã™ã‚‹ã€‚
  RCTCxxBridge *cxxBridge = (RCTCxxBridge *)self.bridge;
  if (!cxxBridge.runtime) {
    return;
  }

  naturalclar::awesomeModule::install(*(jsi::Runtime *)cxxBridge.runtime);
}

- (void)invalidate {
  naturalclar::awesomeModule::cleanup();
}


@end

```

```objectivec 15:26 subtitle="MainQueueãŒç«‹ã¡ä¸ŠãŒã‚‹ã¾ã§å¾…ã¤"
// RNMyModule.mm
#import "MyAwesomeModule.h"

@implementation RNAwesomeModule
@synthesize bridge = _bridge;
@synthesize methodQueue = _methodQueue;

RCT_EXPORT_MODULE()

// Main Queue ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰èµ·å‹•ã™ã‚‹
+ (BOOL)requiresMainQueueSetup {
  return YES;
}

- (void)setBridge:(RCTBridge *)bridge
{
  _bridge = bridge;

  // JS ã¨ c++ ã®ç¹‹ãç›®ã‚’ä½œæˆã™ã‚‹ã€‚
  RCTCxxBridge *cxxBridge = (RCTCxxBridge *)self.bridge;
  if (!cxxBridge.runtime) {
    return;
  }

  naturalclar::awesomeModule::install(*(jsi::Runtime *)cxxBridge.runtime);
}

- (void)invalidate {
  naturalclar::awesomeModule::cleanup();
}


@end

```

```objectivec 28:30 subtitle="cleanupå‡¦ç†ã‚’æ›¸ã"
// RNMyModule.mm
#import "MyAwesomeModule.h"

@implementation RNAwesomeModule
@synthesize bridge = _bridge;
@synthesize methodQueue = _methodQueue;

RCT_EXPORT_MODULE()

// Main Queue ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰èµ·å‹•ã™ã‚‹
+ (BOOL)requiresMainQueueSetup {
  return YES;
}

- (void)setBridge:(RCTBridge *)bridge
{
  _bridge = bridge;

  // JS ã¨ c++ ã®ç¹‹ãç›®ã‚’ä½œæˆã™ã‚‹ã€‚
  RCTCxxBridge *cxxBridge = (RCTCxxBridge *)self.bridge;
  if (!cxxBridge.runtime) {
    return;
  }

  naturalclar::awesomeModule::install(*(jsi::Runtime *)cxxBridge.runtime);
}

- (void)invalidate {
  naturalclar::awesomeModule::cleanup();
}


@end

```

</CodeSurferLayout>

---

## Android å´ (WIP)

---

<CodeSurferLayout>

```
// CMakeList.txt
cmake_minimum_required(VERSION 3.9.0)

add_library(cpp
            SHARED
            ../cpp/example.cpp
            ./cpp-adapter.cpp
)

include_directories(
            ../../react-native/React
            ../../react-native/React/Base
            ../../react-native/ReactCommon/jsi
            ../cpp
)

set_target_properties(
        cpp PROPERTIES
        CXX_STANDARD 17
        CXX_EXTENSIONS OFF
        POSITION_INDEPENDENT_CODE ON
)

target_link_libraries(
        cpp
        android
)
```

```
//build.gradle
  externalNativeBuild {
    cmake {
      path "./CMakeLists.txt"
      version "3.8.0+"
    }
  }
```

</CodeSurferLayout>

---

<Header>Android</Header>

- ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«å¾Œã»ã©è¿½è¨˜ã—ã¾ã™ ğŸ™‡â€â™€ï¸
- **CMake** ã‚’ä½¿ã£ã¦ cpp ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã«å–ã‚Šè¾¼ã‚€
- åŸºæœ¬çš„ã«ã¯ iOS ã¨åŒã˜ã§èµ·å‹•æ™‚ã« JS ã® global ã« module ã‚’ä»•è¾¼ã‚€
- JSI ã¨ Java ã‚’ç¹‹ã JNI adapter ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€`cpp-adapter.cpp` ãŒå¿…è¦

---

## JavaScript å´

---

<CodeSurferLayout>

```js subtitle="JSå´ã¯ã“ã‚Œã ã‘ã€JSIãŒglobalã«é–¢æ•°ã‚’ç”Ÿã‚„ã—ãŸã®ã§ãã‚Œã‚’ä½¿ã†"
// MyModule.js

export const myAwesomeMethod = global.myAwesomeMethod;
```

</CodeSurferLayout>

---

## JSI ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

---

<Header>JSI ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</Header>

- [react-native-reanimated (v2)](https://github.com/software-mansion/react-native-reanimated)
- [react-native-vision-camera](https://github.com/mrousavy/react-native-vision-camera)
- [react-native-mmkv](https://github.com/mrousavy/react-native-mmkv)
- [react-native-multithreading](https://github.com/mrousavy/react-native-multithreading)
- [CommE2E](https://github.com/CommE2E/comm)
- [react-native-quick-base64](https://github.com/craftzdog/react-native-quick-base64)
- [react-native-quick-sqlite](https://github.com/ospfranco/react-native-quick-sqlite)

---

<Header>react-native-reanimated</Header>

- Animation ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–å´ã§å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- JavaScript ã®å‡¦ç†ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã† `worklet` ã®å°å…¥
- JSI ã‚’ä½¿ã†ã«ã‚ãŸã£ã¦ã„ãã¤ã‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’æä¾›ã—ã¦ã„ã‚‹
- å¾Œè¿°ã®`react-native-vision-camera`ã‚„`react-native-multithreading`ã§ä½¿ç”¨

---

<Header>react-native-vision-camera</Header>

- JSI ã‚’ç”¨ã„ãŸå¤šæ©Ÿèƒ½ãªã‚«ãƒ¡ãƒ©ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- åŒæœŸçš„ã« Snapchat ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã©ã‚’ã¤ã‘ã‚Œã‚‹

---

<Header>react-native-mmkv</Header>

- JSI ã‚’ç”¨ã„ãŸ AsyncStorage ã®ï¼•ï¼å€æ—©ã„ Key Value Pair
- MMKV ã¨ã„ã† c++è£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚‹

---

<Header>react-native-multithreading</Header>

- å‡¦ç†ã‚’ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰åŒ–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- JSI ãŒåŒæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ãã‚Œã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã«é€ƒãŒã™ã®ã«ä½¿ç”¨
- JSI é–¢ä¿‚ãªãé‡ã„å‡¦ç†ã‚’ multithread å´ã«é€ƒãŒã™

---

<Header>react-native-quick-base64</Header>

- æš—å·åŒ–ã€å¾©å·åŒ–ã®å‡¦ç†ã‚’ c++å´ã§è¡Œã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

---

<Header>ã¾ã¨ã‚</Header>

- JavaScript ã§ã‚„ã‚‹ã«ã¯é‡ã„å‡¦ç†ã¯ JSI ã‚’ä½¿ã£ã¦ c++ å´ã«å›ã›ã‚‹
- TurboModules, Fabric ã® OSS åŒ–ã‚‚é€²ã‚“ã§ã‚‹
- JSI ã‚’ç”¨ã„ãŸè±Šå¯Œãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚¢ãƒ—ãƒªã‚’é«˜é€ŸåŒ–ã—ã‚ˆã†

---

<Header>å‚è€ƒè³‡æ–™</Header>

- [facebook/react-native/.../jsi.h](https://github.com/facebook/react-native/blob/HEAD/ReactCommon/jsi/jsi/jsi.h)
- [JSI discussion](https://github.com/react-native-community/discussions-and-proposals/issues/91)
- [Getting Started React Native JSI](https://blog.notesnook.com/getting-started-react-native-jsi/)
- [Tweet about jsi + codegen](https://twitter.com/Ashoat/status/1418669067930677248)
- [The New React Native Architecture Explained](https://formidable.com/blog/2019/jsi-jsc-part-2/)
- [ReactNative ã‚¢ãƒ—ãƒªã‚’ 50 å€æ—©ãæ”¹å–„ã—ãŸæ–¹æ³•](https://ichi.pro/reactnative-apuri-o-50-bai-hayaku-kaizenshita-hoho-21807260638852)

---

THANK YOU

---

## ãŠã¾ã‘(æœªæ•´ç†)

---

## JSI ã§ä½¿ã‚ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®è»½ã„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

---

<AlignLeft>

<Header>jsi::Function</Header>

- JavaScript ã® Function å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

```
createFromHostFunction(
  Runtime& runtime,
  jsi::PropNameID& name,
  unsigned int paramCount,
  jsi::HostFunctionType func
  )
```

- JavaScript å´ã‹ã‚‰å‘¼ã°ã‚ŒãŸã‚‰ c++ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°

</AlignLeft>

---

<Header>jsi::Runtime</Header>

- `runtime.global().setProperty(runtime, propertyName)`
- `runtime.global().getProperty(runtime, propertyName)`
- `runtime.global().getPropertyAsObject(runtime, propertyName)`
- `runtime.global().getPropertyAsFunction(runtime, propertyName)`

---

## jsi::Object

JavaScript ã® Object å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

- `setProperty`
- `getProperty`
- `asArray`
- `asFunction`

ä»–ã«ã‚‚ weak ref ã‚’è¡¨ã™ `WeakObject` ãŒå­˜åœ¨ã™ã‚‹

---

## jsi::Value

JavaScript ã® Primitive å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

- `isUndefined()`
- `isNull()`
- `isBool()`
- `isNumber()`
- `isString()`
- `getBool()`
- `getString()`
  ...

---

## jsi::Array

JavaScript ã® Array ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

## jsi:PropNameID

JavaScript ã® Property Key ã«ãªã‚Šå¾—ã‚‹å‹

---

END
