import Code from "mdx-code";
import { Notes, Head, Appear } from "mdx-deck";
import {
  Avatar,
  Logo,
  Meta,
  Profile,
  Title,
} from "@naturalclar/slides-components";
import { CodeSurferLayout, CodeSurferColumnLayout } from "code-surfer";
import "prismjs/components/prism-tsx";

<Head>
  <Meta
    title="jsi-in-a-nutshell"
    description="Enter description here"
    publishedAt={"2021-07-27T13:13:07.542Z"}
    host="https://jsi-in-a-nutshell.vercel.app"
  />
</Head>

## JSI in a nutshell

<footer style={{position:'absolute', bottom: 20, right: 20}}>

[TECH STAND #5](https://standfm.connpass.com/event/218812/)
@naturalclar

</footer>

<Notes>
  JSI in a Nutshell ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã§ç™»å£‡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚Naturalclarã§ã™ã€‚
</Notes>

---

<Title>About Me</Title>

<Profile />

<Notes>Introduction</Notes>

---

## æ¦‚è¦

- JSI ã¨ã¯
- JSI ã®åˆ©ç‚¹
- JSI ã®ä½¿ã„æ–¹
- JSI ã‚’ä½¿ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªç´¹ä»‹

---

## JSI ã¨ã¯? ğŸ¤”

---

## JSI

- JavaScripe Engine ã®ãƒ©ãƒƒãƒ‘ãƒ¼
- C++ ã¸ã®å‚ç…§ã‚’æŒã¤
- New Architecture ã®ä¸€ç’°

---

---

## New Architecture

ç¾çŠ¶ã® Native Module ã¨ UI Rendererã€ãã—ã¦ New Architecture å¾Œã®çŠ¶æ…‹ã«ã¤ã„ã¦è©±ã™

New Architecture ã®ä¸­æ ¸ã¨ãªã‚‹ã®ãŒã“ã® JSI

---

## JSI ã®åˆ©ç‚¹

- TurboModules - Native Module ã®åŒæœŸçš„å‘¼ã³å‡ºã—
- Fabric - Yoga ã«ç›´æ¥ ShadowDOM ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã«ã‚ˆã‚‹æç”»ã®é«˜é€ŸåŒ–

<Notes>
  ä»Šå›ã¯JSIã‚’ä½¿ã£ã¦ã€JavaScriptã‹ã‚‰C++ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚’è¡Œã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œã‚Šæ–¹ã‚’è§£èª¬ã—ã¾ã™
</Notes>

---

## Example Code

```tsx

```

```cpp
// MyAwesomeModule.cpp
#import "MyAwesomeModule.h"

using namespace facebook;

namespace naturalclar {
  namespace awesomeModule {

    void install(jsi::Runtime& runtime) {
      auto myAwesomeMethod = jsi::Function::createFromHostFunction(
        runtime, // å¼•æ•°ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ jsi ã® runtime ã‚’ãã®ã¾ã¾æ¸¡ã™
        jsi::PropNameID::forAscii(runtime, "myAwesomeMethod"), // JavaScriptå´ã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®åå‰
        2, // é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®æ•°
        [](jsi::Runtime& rt, const jsi::Value& thisVal, const jsi::Value* args, size_t count) -> jsi::Value {
          // c++ ã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
          // jsi::Value ã‚’è¿”ã™ã‹ã€Exception ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹

          return jsi::Value(-42);
        }
      );

      // JavaScript ã® global ã« method ã‚’è¿½åŠ ã™ã‚‹
      runtime.global().setProperty(runtime, "myAwesomeMethod", std::move(myAwesomeMethod));
    }

  }
}

```

---

## iOS ã‹ã‚‰ã®å‘¼ã³å‡ºã—æ–¹

`.mm` ãƒ•ã‚¡ã‚¤ãƒ«ãŒ Objective-c ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã¤ã€c++ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¹ã¾ã™

```Objective-c
// RNMyModule.mm
#import "MyAwesomeModule.h"

@implementation RNMultithreading
@synthesize bridge = _bridge;
@synthesize methodQueue = _methodQueue;

RCT_EXPORT_MODULE()

// Main Queue ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰èµ·å‹•ã™ã‚‹
+ (BOOL)requiresMainQueueSetup {
  return YES;
}

- (void)setBridge:(RCTBridge *)bridge
{
  _bridge = bridge;

  // JS ã¨ c++ ã®ç¹‹ãç›®ã‚’ä½œæˆã™ã‚‹ã€‚
  RCTCxxBridge *cxxBridge = (RCTCxxBridge *)self.bridge;
  if (!cxxBridge.runtime) {
    return;
  }

  naturalclar::awesomeModule::install(*(jsi::Runtime *)cxxBridge.runtime);
}

@end






```

---

## Android ã‹ã‚‰ã®å‘¼ã³å‡ºã—æ–¹

Android ã®å ´åˆã€`fbjni` ã¨ã„ã† Java ã‹ã‚‰ c++ ã‚’å‘¼ã³å‡ºã›ã‚‹ ffi ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

---

## jsi::Function

JavaScript ã® Function å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

- `createFromHostFunction(Runtime& runtime, const jsi::PropNameID& name, unsigned int paramCount, jsi::HostFunctionType func)`

JavaScript å´ã‹ã‚‰å‘¼ã°ã‚ŒãŸã‚‰ c++ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã€‚

---

## jsi::HostFunctionType

```cpp
using HostFunctionType = std::function<
    Value(Runtime& rt, const Value& thisVal, const Value* args, size_t count)>;
```

JavaScript ã‹ã‚‰å‘¼ã³ã ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã®å‹ã€‚
å€¤ã‚’è¿”ã™ã‹ã€Exeption ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ã‚‚ã—ã€C++ Exeption ãŒæŠ•ã’ã‚‰ã‚ŒãŸã‚‰ãã‚Œã‚’ JS Error ã«å¤‰æ›ã—ã¦ JS å´ã«æŠ•ã’ã‚‹ã€‚

---

## jsi::Runtime

- `runtime.global().setProperty(runtime, propertyName)`
- `runtime.global().getProperty(runtime, propertyName)`
- `runtime.global().getPropertyAsObject(runtime, propertyName)`
- `runtime.global().getPropertyAsFunction(runtime, propertyName)`

---

## jsi::Object

JavaScript ã® Object å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

- `setProperty`
- `getProperty`
- `asArray`
- `asFunction`

ä»–ã«ã‚‚ weak ref ã‚’è¡¨ã™ `WeakObject` ãŒå­˜åœ¨ã™ã‚‹

---

## jsi::Value

JavaScript ã® Primitive å‹ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

- `isUndefined()`
- `isNull()`
- `isBool()`
- `isNumber()`
- `isString()`
- `getBool()`
- `getString()`
  ...

---

## jsi::Array

JavaScript ã® Array ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹

## jsi:PropNameID

JavaScript ã® Property Key ã«ãªã‚Šå¾—ã‚‹å‹

---

ãã®ä»–è©³ç´°

- [jsi.h](https://github.com/facebook/react-native/blob/HEAD/ReactCommon/jsi/jsi/jsi.h)

---

## react-native-codegen

C++ ã¯å‹ãŒå¿…é ˆãªè¨€èªãªã®ã§ã€ JavaScript ã¨ C++ ã‚’ç¹‹ãç‚ºã®å‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

æ‰‹ã§æ›¸ãã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€Flow ã‚„ TypeScript ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰å‹ã‚’ç”Ÿæˆã™ã‚‹ç‚ºã® CodeGen ã‚’ã€FlowType ç”¨ã¯ Facebookã€TypeScript ç”¨ã¯ Microsoft ãŒä½œæˆã—ã¦ã„ã¾ã™ã€‚

---

## codegen ã®ä½¿ã„æ–¹ã¨å‡ºåŠ›ä¾‹

---

## JSI ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [react-native-reanimated (v2)](https://github.com/software-mansion/react-native-reanimated)
- [react-native-vision-camera](https://github.com/mrousavy/react-native-vision-camera)
- [react-native-mmkv](https://github.com/mrousavy/react-native-mmkv)
- [react-native-multithreading](https://github.com/mrousavy/react-native-multithreading)
- [CommE2E](https://github.com/CommE2E/comm)
- [react-native-quick-base64](https://github.com/craftzdog/react-native-quick-base64)
- [react-native-sqlite]()

---

## react-native-reanimated

- Animation ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–å´ã§å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- JSI ã‚’ä½¿ã†ã«ã‚ãŸã£ã¦ã„ãã¤ã‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’æä¾›ã—ã¦ã„ã‚‹
- å¾Œè¿°ã®`react-native-vision-camera`ã‚„`react-native-multithreading`ã§ä½¿ç”¨

---

## react-native-vision-camera

- åŒæœŸçš„ã« Snapchat ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã©

---

## react-native-mmkv

- AsyncStorage ã®ï¼•ï¼å€æ—©ã„ Key Value Pair
- MMKV ã‚’ä½¿ã£ã¦ã‚‹

---

## react-native-multithreading

- å‡¦ç†ã‚’ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰åŒ–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- JSI ãŒåŒæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ãã‚Œã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã«é€ƒãŒã™ã®ã«ä½¿ç”¨
- JSI é–¢ä¿‚ãªãé‡ã„å‡¦ç†ã‚’ multithread å´ã«é€ƒãŒã™
